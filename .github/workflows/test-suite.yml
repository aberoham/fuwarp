name: Test Suite

on:
  push:
    branches: [ main ]
    paths:
      - 'fuwarp.py'
      - 'fuwarp_windows.py'
      - 'test_suite/**'
      - '.github/workflows/test-suite.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'fuwarp.py'
      - 'fuwarp_windows.py'
      - 'test_suite/**'
      - '.github/workflows/test-suite.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Detect which files changed to conditionally run platform-specific tests
  changes:
    runs-on: ubuntu-latest
    outputs:
      fuwarp: ${{ steps.filter.outputs.fuwarp }}
      fuwarp_windows: ${{ steps.filter.outputs.fuwarp_windows }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          fuwarp:
            - 'fuwarp.py'
            - 'test_suite/test_fuwarp_integration.py'
          fuwarp_windows:
            - 'fuwarp_windows.py'
            - 'test_suite/test_fuwarp_windows.py'

  test-macos:
    runs-on: macos-latest
    needs: changes
    if: needs.changes.outputs.fuwarp == 'true' || github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v4

    - name: Set up uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install test dependencies
      working-directory: test_suite
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -r requirements.txt

    - name: Run tests
      working-directory: test_suite
      run: |
        source .venv/bin/activate
        python -m pytest test_fuwarp_integration.py -v --tb=short

  test-linux:
    runs-on: ubuntu-latest
    needs: [changes, test-macos]  # Only run after macOS tests pass
    if: needs.changes.outputs.fuwarp == 'true' || github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v4

    - name: Set up uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install test dependencies
      working-directory: test_suite
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -r requirements.txt

    - name: Run tests
      working-directory: test_suite
      run: |
        source .venv/bin/activate
        python -m pytest test_fuwarp_integration.py -v --tb=short

  test-windows:
    runs-on: windows-latest
    needs: [changes, test-macos]  # Only run after macOS tests pass
    # Only run when fuwarp_windows.py or its tests change
    if: needs.changes.outputs.fuwarp_windows == 'true' || github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install test dependencies
      working-directory: test_suite
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Windows-specific tests
      working-directory: test_suite
      run: |
        python -m pytest test_fuwarp_windows.py -v --tb=short
