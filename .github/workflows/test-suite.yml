name: Test Suite

on:
  push:
    branches: [ main ]
    paths:
      - 'fuwarp.py'
      - 'test_suite/**'
      - '.github/workflows/test-suite.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'fuwarp.py'
      - 'test_suite/**'
      - '.github/workflows/test-suite.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      run: pip3 install uv

    - name: Install test dependencies
      working-directory: test_suite
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -r requirements.txt

    - name: Run tests
      working-directory: test_suite
      run: |
        source .venv/bin/activate
        python -m pytest test_fuwarp_integration.py -v --tb=short

  test-linux:
    runs-on: ubuntu-latest
    needs: test-macos  # Only run after macOS tests pass

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      run: pip install uv

    - name: Install test dependencies
      working-directory: test_suite
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -r requirements.txt

    - name: Run tests
      working-directory: test_suite
      run: |
        source .venv/bin/activate
        python -m pytest test_fuwarp_integration.py -v --tb=short
