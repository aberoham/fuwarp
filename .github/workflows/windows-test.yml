name: Windows Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'fuwarp-windows.py'
      - '.github/workflows/windows-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'fuwarp-windows.py'
      - '.github/workflows/windows-test.yml'

jobs:
  test-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    # Just use whatever Python comes with windows-latest
    # No need to test multiple versions for basic file operations

    - name: Create mock warp-cli
      shell: pwsh
      run: |
        # Create a mock warp-cli.bat that returns a test certificate
        @'
        @echo off
        if "%1"=="certs" (
          echo -----BEGIN CERTIFICATE-----
          echo MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF
          echo ADAkMSIwIAYDVQQDDBlDbG91ZGZsYXJlIEZvciBUZWFtcyBFQ0MwHhcNMjAwODAz
          echo -----END CERTIFICATE-----
        )
        if "%1"=="status" (
          echo Status: Connected
        )
        '@ | Out-File -FilePath warp-cli.bat -Encoding ASCII

        # Add current directory to PATH so our mock is found
        echo "$PWD" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Test script imports and basic functionality
      shell: pwsh
      run: |
        python -c "import sys; sys.path.insert(0, '.'); from fuwarp_windows import FuwarpWindows; print('Import successful')"
        python fuwarp-windows.py --help
        python fuwarp-windows.py --version

    - name: Test in status mode (read-only)
      shell: pwsh
      run: python fuwarp-windows.py

    - name: Test path construction
      shell: pwsh
      run: |
        python -c @"
        import os
        import sys
        sys.path.insert(0, '.')
        from fuwarp_windows import FuwarpWindows

        # Test that paths are properly constructed for Windows
        fw = FuwarpWindows(mode='status', debug=True)

        # Test get_tool_bundle_path
        path = fw.get_tool_bundle_path('test')
        print(f'Bundle path: {path}')

        # Check no mixed separators (shouldn't have forward slashes after drive letter)
        if ':' in path:  # Windows path with drive letter
            path_after_drive = path[2:]  # Skip 'C:' part
            assert '/' not in path_after_drive, f'Mixed separators found: {path}'

        # Test that CLOUDFLARE_WARP_DIR uses proper separators
        import fuwarp_windows
        warp_dir = fuwarp_windows.CLOUDFLARE_WARP_DIR
        print(f'WARP dir: {warp_dir}')

        if ':' in warp_dir:
            warp_after_drive = warp_dir[2:]
            assert '/' not in warp_after_drive, f'Mixed separators in CLOUDFLARE_WARP_DIR: {warp_dir}'

        print('Path construction tests passed')
        "@

    - name: Test certificate download with mock
      shell: pwsh
      run: |
        python -c @"
        import sys
        sys.path.insert(0, '.')
        from fuwarp_windows import FuwarpWindows

        fw = FuwarpWindows(mode='status', debug=True)
        result = fw.download_certificate()
        assert result == True, 'Certificate download should succeed with mock'
        print('Certificate download test passed')
        "@

    - name: Test specific bug fix - same file copy protection
      shell: pwsh
      run: |
        # Test that we don't try to copy a file to itself
        python -c @"
        import os
        import sys
        import tempfile
        sys.path.insert(0, '.')
        from fuwarp_windows import FuwarpWindows

        fw = FuwarpWindows(mode='status', debug=True)

        # Create a temp file to test with
        with tempfile.NamedTemporaryFile(mode='w', suffix='.pem', delete=False) as tf:
            tf.write('test content')
            temp_path = tf.name

        try:
            # Test that append_certificate_if_missing handles same file gracefully
            result = fw.append_certificate_if_missing(temp_path, temp_path)
            assert result == True, 'Should handle same file gracefully'
            print('Same-file protection test passed')
        finally:
            os.unlink(temp_path)
        "@